
@{
    ViewBag.Title = "Danh sách các sự kiện";
}

<div class="panel">
    <div class="panel-body">
        <div class="col-md-6">
            <h3>Danh sách các sự kiện</h3>
        </div>
        <div class="col-md-6 text-right">
            <a href="/PlaceOwner/Event/CreateEvent" class="btn btn-success"><i class="fa fa-plus" aria-hidden="true"></i> Tạo mới sự kiện</a>
        </div>
    </div>
</div>
<div class="panel">
    <div class="panel-body">
        <table class="table table-striped table-bordered table-hover" id="listEventTable">
            <thead>
                <tr>
                    <th>Số thứ tự</th>
                    <th>Tên sự kiện</th>
                    <th>Hình ảnh</th>
                    <th>Ngày bắt đầu</th>
                    <th>Ngày kết thúc</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalEventDetail" aria-hidden="true"
     aria-labelledby="modalEventDetail" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="event-detail-modal-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateEventModal" aria-hidden="true"
     aria-labelledby="updateEventModal" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="event-update-modal-container"></div>
        </div>
    </div>
</div>


@section Scripts{

    <script>

        (function (document, window, $) {
            'use strict';

            var Site = window.Site;
            $(document).ready(function () {
                Site.run();
            });
        })(document, window, jQuery);

        function deleteEvent(id) {
            bootbox.dialog({
                message: "Bạn có chắc muốn xóa sự kiện này?",
                title: "Xác nhận xóa",
                buttons: {
                    success: {
                        label: "Hủy",
                        className: "btn-default",
                        callback: function () {

                        }
                    },
                    danger: {
                        label: "Đồng ý",
                        className: "btn-danger",
                        callback: function () {
                            $.ajax({
                                url: "/PlaceOwner/Event/deleteEvent",
                                data: {
                                    format: 'json',
                                    id: id
                                },
                                error: function () {
                                    alert("Problem!")
                                },
                                success: function (data) {
                                    if (data === "success") {
                                        bootbox.alert("Đã xóa thành công", function () {
                                            RefreshTable();
                                        });

                                    }
                                },
                                type: 'POST'
                            })
                        }
                    }
                }
            });
        }

        function scriptForPartialView() {

            $('#delBtn').click(function (id) {
                console.log(id)
                bootbox.dialog({
                    message: "Bạn có chắc muốn xóa sự kiện này?",
                    title: "Xác nhận xóa",
                    buttons: {
                        success: {
                            label: "Hủy",
                            className: "btn-default",
                            callback: function () {

                            }
                        },
                        danger: {
                            label: "Đồng ý",
                            className: "btn-danger",
                            callback: function () {
                                $.ajax({
                                    url: "/PlaceOwner/Event/deleteEvent",
                                    data: {
                                        format: 'json',
                                        id: id
                                    },
                                    error: function () {
                                        alert("Problem!")
                                    },
                                    success: function (data) {
                                        if (data === "success") {
                                            bootbox.alert("Đã xóa thành công", function () {
                                                $('#updateEventModal').modal('toggle');
                                                RefreshTable();
                                            });

                                        }
                                    },
                                    type: 'POST'
                                })
                            }
                        }
                    }
                });
            })

            function deleteEventModal(id) {
                bootbox.dialog({
                    message: "Bạn có chắc muốn xóa sự kiện này?",
                    title: "Xác nhận xóa",
                    buttons: {
                        success: {
                            label: "Hủy",
                            className: "btn-default",
                            callback: function () {

                            }
                        },
                        danger: {
                            label: "Đồng ý",
                            className: "btn-danger",
                            callback: function () {
                                $.ajax({
                                    url: "/PlaceOwner/Event/deleteEvent",
                                    data: {
                                        format: 'json',
                                        id: id
                                    },
                                    error: function () {
                                        alert("Problem!")
                                    },
                                    success: function (data) {
                                        if (data === "success") {
                                            bootbox.alert("Đã xóa thành công", function () {
                                                $('#updateEventModal').modal('toggle');
                                                RefreshTable();
                                            });

                                        }
                                    },
                                    type: 'POST'
                                })
                            }
                        }
                    }
                });
            };

            $('#eventForm').submit(function (e) {
                e.preventDefault();
                var formData = new FormData(document.getElementById('eventForm'));
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("updateEvent")',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        if (result.Succeed) {
                            bootbox.alert("Cập nhật thành công", function () {
                                $('#updateEventModal').modal('toggle');
                                RefreshTable();
                            })
                            
                        } else {
                            showErrors(result.Errors);
                        }

                    },
                    error: function (result) {
                        showMessage("Có lỗi xảy ra. Vui lòng thử lại sau.", "error", "OK");
                    },
                });


            });
        }

        function showDetail(id) {
            $.ajax({
                url: '@Url.Action("EventDetailModal")',
                type: 'Get',
                data: { id: id },
                success: function (data) {
                    $('#event-detail-modal-container').html(data);
                    $('#modalEventDetail').modal('show');
                },
                error: function (error) {
                    showMessage("Có lỗi xảy ra. Vui lòng thử lại sau.", "error", "OK");
                }
            });

        }

        function showUpdate(id) {
            $.ajax({
                url: '@Url.Action("EventDetail")',
                type: 'Get',
                data: { id: id },
                success: function (data) {
                    $('#event-update-modal-container').html(data);
                    $('#updateEventModal').modal('show');
                    scriptForPartialView();
                },
                error: function (error) {
                    showMessage("Có lỗi xảy ra. Vui lòng thử lại sau.", "error", "OK");
                }
            });
        }

        function RefreshTable() {
            var oTable = $("#listEventTable").dataTable();
            oTable._fnPageChange(0);
            oTable._fnAjaxUpdate();
        };

        function InitDatatable() {
            $("#listEventTable").DataTable({
                "bRetrieve": true,
                "bServerSide": true,
                "bScrollCollapse": true,
                "bSort": true,
                "sAjaxSource": "/PlaceOwner/Event/GetData",
                "bProcessing": true,
                @*"fnServerParams": function (aoData) {
                    aoData.push({ "name": "id", "value": @ViewBag.storeId });
                },*@
                "aLengthMenu": [10, 20, 50],
                "oLanguage": {
                    "sSearch": "Tìm kiếm:",
                    "sZeroRecords": "Không có dữ liệu phù hợp",
                    "sInfo": "Hiển thị từ _START_ đến _END_ trên tổng số _TOTAL_ dòng",
                    "sEmptyTable": "Không có dữ liệu",
                    "sInfoFiltered": " - lọc ra từ _MAX_ dòng",
                    "sLengthMenu": "Hiển thị _MENU_ dòng",
                    "sProcessing": "Đang xử lý...",
                    "oPaginate": {
                        "sPrevious": "Trang trước",
                        "sNext": "Trang kế"
                    }
                },

                @*"fnDrawCallback": function (settings) {
                    $(':checkbox').change(function () {
                        if ($(this).prop('checked') == true) {
                            $.ajax({
                                url: "/BlogPostManage/@ViewBag.storeId/@ViewBag.storeName/BlogPost/ChangeStatus",
                                type: 'POST',
                                data: {
                                    'blogPostId': $(this).val(),
                                    'status': 'Activate'
                                },
                                dataType: 'json',
                                success: function (result) {
                                    ReDrawDatatable("listBlogPostTable");
                                }
                            });
                        } else {
                            $.ajax({
                                url: "/BlogPostManage/@ViewBag.storeId/@ViewBag.storeName/BlogPost/ChangeStatus",
                                type: 'POST',
                                data: {
                                    'blogPostId': $(this).val(),
                                    'status': 'Deactivate'
                                },
                                dataType: 'json',
                                success: function (result) {
                                    ReDrawDatatable("listBlogPostTable");
                                }
                            });
                        }
                    });
                },*@
                "aoColumnDefs": [
                    {
                        "aTargets": [0],
                        "mRender": function (data, type, o) {
                            return 1;
                        }
                    },
                    {
                        "aTargets": [1],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            return o[1];
                        }
                    },
                    {
                        "aTargets": [2],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            return "<img src='" + o[5] + "' width='100' />";
                        }
                    },
                    {
                        "aTargets": [3],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            var date = new Date(parseInt(o[3].substr(6)));
                            var month = parseInt(date.getMonth()) + 1;
                            var formattedDate = date.getDate() + "/" + month + "/" + date.getFullYear();
                            return "<p>" + formattedDate + "</p>";
                        }
                    },
                    {
                        "aTargets": [4],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            var date = new Date(parseInt(o[4].substr(6)));
                            var month = parseInt(date.getMonth()) + 1;
                            var formattedDate = date.getDate() + "/" + month + "/" + date.getFullYear();
                            return "<p>" + formattedDate + "</p>";
                        }
                    },
                    {
                        "aTargets": [5],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            if (o[6] == 1) {
                                return "<span class='label label-lg label-outline label-success'>Đang diễn ra</span>";
                            } else {
                                return "<span class='label label-lg label-outline label-warning'>Kết thúc</span>";
                            }
                        }
                    },
                    {
                        "aTargets": [6],
                        "bSortable": false,
                        "mRender": function (data, type, o) {
                            var viewDetailBtn = "<a href='javascript:void(0)' class='btn btn-success' data-target='#modalEventDetail' data-toggle='modal' onclick='showDetail(" + o[0] + ")'><i class='fa fa-eye' aria-hidden='true'></i></a>";
                            var updateBtn = "<a href='javascript:void(0)' class='btn btn-warning' data-target='#updateEventModal' data-toggle='modal' onclick='showUpdate(" + o[0] + ")'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a>";
                            var deleteBtn = "<a href='javascript:void(0)' class='btn btn-danger' onclick='deleteEvent(" + o[0] + ")'><i class='fa fa-trash-o' aria-hidden='true'></i></a>";
                            return viewDetailBtn + '&nbsp;' + updateBtn + '&nbsp;' + deleteBtn;;
                        }
                    }

                ],

            });
        };

        $(document).ready(function () {
            InitDatatable();
            RefreshTable();
            //loadlist();
        });

    </script>

    }